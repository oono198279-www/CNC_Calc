<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>CNC 計算ツール</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1f2937">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">

  <!-- 表示 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body { margin:0; padding:0; font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:#fff; color:#111827; }
    header { position:sticky; top:0; background:#fff; border-bottom:1px solid #e5e7eb; padding: calc(12px + var(--safe-top)) 16px 12px; z-index:10; }
    h1 { font-size:18px; margin:0; }
    .wrap { padding:12px 12px 90px; max-width:900px; margin:0 auto; }
    .tabs { display:flex; gap:6px; overflow-x:auto; padding-bottom:8px; border-bottom:1px solid #e5e7eb; }
    .tab-btn { flex:0 0 auto; border:1px solid #d1d5db; padding:8px 10px; border-radius:8px; background:#f9fafb; cursor:pointer; font-size:14px; }
    .tab-btn.active { background:#e0ecff; border-color:#b6c5ff; }
    .panel { display:none; padding-top:12px; }
    .panel.active { display:block; }
    .card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:10px 0; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,0.03); }
    .row { display:grid; grid-template-columns: 1fr 180px; gap:8px; align-items:center; margin:8px 0; }
    .row label { font-size:14px; }
    .row input, .row select { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; font-size:16px; }
    .btn { width:100%; padding:12px; font-size:16px; border-radius:10px; border:1px solid #cbd5ff; background:#e8f0ff; cursor:pointer; }
    .btn:active { transform:translateY(1px); }
    .result { font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#f7f7f9; border:1px dashed #d1d5db; border-radius:8px; padding:10px; white-space:pre-wrap; }
    .hint { font-size:12px; color:#6b7280; }
    .imgbox, .svgbox { width:100%; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:6px; background:#f9fafb; }
    .imgbox img { max-width:100%; height:auto; display:block; margin:auto; }
    footer { position:fixed; left:0; right:0; bottom:0; padding:8px 12px calc(8px + var(--safe-bottom)); border-top:1px solid #e5e7eb; background:#fff; text-align:center; font-size:12px; color:#6b7280; }
    #mode { position:fixed; right:8px; bottom:6px; font:12px/1.2 ui-monospace; opacity:.5; }
  </style>
</head>
<body>
  <header><h1>CNC 計算ツール</h1></header>

  <div class="wrap">
    <div class="tabs">
      <button class="tab-btn active" data-tab="rpm">主軸回転数</button>
      <button class="tab-btn" data-tab="roughness">面粗度→送り（Ra/Rz）</button>
      <button class="tab-btn" data-tab="milling">フライス長さ</button>
      <button class="tab-btn" data-tab="cornerR">角部R 座標</button>
    </div>

    <div id="rpm" class="panel active">
      <div class="card">
        <div class="row">
          <label>周速度 Vc <span class="hint">(m/min)</span></label>
          <input id="rpm_vc" type="number" inputmode="decimal" step="0.0001" value="94.2478">
        </div>
        <div class="row">
          <label>材料径 φ <span class="hint">(直径 mm)</span></label>
          <input id="rpm_d" type="number" inputmode="decimal" step="0.0001" value="10">
        </div>
        <button class="btn" onclick="runRPM()">計算</button>
        <div class="result" id="rpm_out"></div>
        <div class="hint">※表示は「小数切り捨て（整数）」で出力。計算自体は Math.PI を使用。</div>
      </div>
    </div>

    <div id="roughness" class="panel">
      <div class="card">
        <div class="row">
          <label>表記</label>
          <select id="rf_mode" onchange="toggleRMode()">
            <option value="ra" selected>Ra（μm）係数32</option>
            <option value="rz">Rz（μm）/ Excel互換（8則）</option>
          </select>
        </div>

        <div id="ra_block">
          <div class="row">
            <label>Ra（μm）</label>
            <input id="rf_ra" type="number" inputmode="decimal" step="0.0001" value="3.15">
          </div>
        </div>

        <div id="rz_block" style="display:none">
          <div class="row">
            <label>Rz（μm）</label>
            <input id="rf_rz" type="number" inputmode="decimal" step="0.0001" value="3.15">
          </div>
          <div class="row">
            <label>参考換算 k <span class="hint">(Ra ≈ Rz / k)</span></label>
            <select id="rf_k">
              <option value="4">k=4</option>
              <option value="6">k=6</option>
              <option value="7" selected>k=7</option>
            </select>
          </div>
          <div class="hint">※Rz→Ra換算は定義が異なるため厳密ではありません。社内基準に従ってください。</div>
        </div>

        <div class="row">
          <label>チップコーナーR <span class="hint">(mm)</span></label>
          <input id="rf_r" type="number" inputmode="decimal" step="0.0001" value="0.05">
        </div>
        <div class="row">
          <label>主軸回転数 <span class="hint">(rpm)</span></label>
          <input id="rf_rpm" type="number" inputmode="decimal" step="1" value="4000">
        </div>
        <button class="btn" onclick="calcRough()">計算</button>
        <div class="result" id="rf_out"></div>
      </div>
    </div>

    <div id="milling" class="panel">
      <div class="card">
        <details open>
          <summary>図解</summary>
          <div class="imgbox">
            <img id="milling_img" src="Image/milling_illustration.png" alt="フライス長さの計算式（ブック図）"
                 onerror="this.style.display='none'; document.getElementById('milling_svg_wrap').style.display=''">
          </div>
          <div class="svgbox" id="milling_svg_wrap" style="display:none;">
            <svg viewBox="0 0 360 220">
              <circle cx="110" cy="110" r="60" fill="none" stroke="#111827" stroke-width="2"/>
              <circle cx="240" cy="80" r="30" fill="none" stroke="#111827" stroke-width="2"/>
              <line x1="240" y1="80" x2="240" y2="50" stroke="#9ca3af"/>
              <text x="246" y="66" style="font-size:12px">d</text>
              <line x1="210" y1="50" x2="270" y2="50" stroke="#2563eb" stroke-width="3"/>
              <text x="215" y="42" style="font-size:12px">h = √((φ/2)^2 − d^2)</text>
              <line x1="40" y1="180" x2="320" y2="180" stroke="#10b981" stroke-width="2"/>
              <text x="48" y="196" style="font-size:12px">始点 = h + D/2 + エア, 終点 = −(h + エア)</text>
            </svg>
          </div>
        </details>

        <div class="row">
          <label>エンドミル直径 D (mm)</label>
          <input id="ml_d" type="number" inputmode="decimal" step="0.0001" value="4">
        </div>
        <div class="row">
          <label>材料直径 φ (mm)</label>
          <input id="ml_phi" type="number" inputmode="decimal" step="0.0001" value="3.56">
        </div>
        <div class="row">
          <label>中心からの長さ d (mm)</label>
          <input id="ml_dlen" type="number" inputmode="decimal" step="0.0001" value="1.5">
        </div>
        <div class="row">
          <label>エアカット量 (mm)</label>
          <input id="ml_air" type="number" inputmode="decimal" step="0.0001" value="0.1">
        </div>
        <button class="btn" onclick="calcMill()">計算</button>
        <div class="result" id="ml_out"></div>
      </div>
    </div>

    <div id="cornerR" class="panel">
      <div class="card">
        <details open>
          <summary>図解</summary>
          <div class="imgbox">
            <img id="corner_img" src="Image/corner_r_calc.png" alt="角部Rのプログラム計算式（外径部R）"
                 onerror="this.style.display='none'; document.getElementById('corner_svg_wrap').style.display=''">
          </div>
          <div class="svgbox" id="corner_svg_wrap" style="display:none;">
            <svg viewBox="0 0 360 260">
              <line x1="60" y1="20" x2="60" y2="240" stroke="#9ca3af"/>
              <line x1="20" y1="220" x2="340" y2="220" stroke="#9ca3af"/>
              <text x="44" y="16" style="font-size:12px">Z</text><text x="342" y="232" style="font-size:12px">X</text>
              <line x1="280" y1="40" x2="280" y2="240" stroke="#111827" stroke-dasharray="4 3"/>
              <text x="258" y="32" style="font-size:12px">外径 φ</text>
              <line x1="210" y1="190" x2="280" y2="220" stroke="#2563eb" stroke-width="2"/>
              <text x="214" y="180" style="font-size:12px">指令面長 = 面長 + 補正量</text>
              <path d="M280,220 Q255,185 230,195" fill="none" stroke="#f43f5e" stroke-width="2"/>
              <text x="252" y="190" style="font-size:12px">R②</text>
              <circle cx="280" cy="220" r="3" fill="#111827"/><text x="286" y="224" style="font-size:12px">D</text>
              <circle cx="245" cy="200" r="3" fill="#111827"/><text x="251" y="204" style="font-size:12px">C</text>
              <circle cx="220" cy="205" r="3" fill="#111827"/><text x="226" y="209" style="font-size:12px">B</text>
              <circle cx="210" cy="220" r="3" fill="#111827"/><text x="216" y="224" style="font-size:12px">A</text>
            </svg>
          </div>
        </details>

        <div class="row">
          <label>外径 φ (mm)</label>
          <input id="cr_phi" type="number" inputmode="decimal" step="0.0001" value="11.2">
        </div>
        <div class="row">
          <label>面長さ (mm)</label>
          <input id="cr_len" type="number" inputmode="decimal" step="0.0001" value="0.9">
        </div>
        <div class="row">
          <label>R② (mm)</label>
          <input id="cr_r2" type="number" inputmode="decimal" step="0.0001" value="0.05">
        </div>
        <div class="row">
          <label>R① (mm)</label>
          <input id="cr_r1" type="number" inputmode="decimal" step="0.0001" value="0">
        </div>
        <div class="row">
          <label>角度 θ (度)</label>
          <input id="cr_theta" type="number" inputmode="decimal" step="0.0001" value="45">
        </div>
        <div class="row">
          <label>Z値 (mm)</label>
          <input id="cr_zval" type="number" inputmode="decimal" step="0.0001" value="5">
        </div>
        <div class="row">
          <label>刃具ノーズR (mm)</label>
          <input id="cr_nose" type="number" inputmode="decimal" step="0.0001" value="0.1">
        </div>
        <button class="btn" onclick="calcCornerR()">計算</button>
        <div class="result" id="cr_out"></div>
      </div>
    </div>
  </div>

  <footer>© CNC quick calc（GitHub Pages）</footer>

  <script>
    const $ = (id)=>document.getElementById(id);
    const rad = (deg)=>deg*Math.PI/180;
    const fmt = (x)=>isFinite(x)?(Math.round(x*10000)/10000).toString():"—";
    // --- 4桁固定表示＆列揃え ---
    const f4 = (x)=> isFinite(x) ? Number(x).toFixed(4) : "—";  // 5 -> 5.0000
    const pad = (s, n)=> s.toString().padStart(n, ' ');         // 左側スペース埋め
    const coordRow = (label, x, z)=>{
      const xs = pad(f4(x), 8);  // 8桁ぶん確保（必要なら調整）
      const zs = pad(f4(z), 8);
      return `${label}点: X=${xs} , Z=${zs}`;
    };

    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });

    function runRPM(){
      const Vc = parseFloat($("rpm_vc").value);
      const D  = parseFloat($("rpm_d").value);
      const n  = 1000.0*Vc/(Math.PI*D);
      const rps = n/60.0;
      $("rpm_out").textContent = `主軸回転数: ${Math.trunc(n)} rpm\n１秒間の回転数: ${Math.trunc(rps)} rps`;
    }

    function toggleRMode(){
      const m=$("rf_mode").value;
      $("ra_block").style.display = m==="ra"?"":"none";
      $("rz_block").style.display = m==="rz"?"":"none";
    }
    function calcRough(){
      const mode = $("rf_mode").value;
      const R = parseFloat($("rf_r").value);
      const rpm = parseFloat($("rf_rpm").value);
      let Ra_um = null, coeff = null, note = "";
      if(mode === "ra"){
        Ra_um = parseFloat($("rf_ra").value);
        coeff = 32;
        note = "（Ra係数32で計算）";
      } else {
        const rz = parseFloat($("rf_rz").value);
        const k  = parseFloat($("rf_k").value);
        const Ra_from_Rz = rz / k;
        Ra_um = rz;
        coeff = 8;
        note = "（Rz×8則 / 参考Ra≈Rz/k=" + (Math.round(Ra_from_Rz*10000)/10000) + "μm）";
      }
      const f_rev = Math.sqrt((Ra_um * R * coeff) / 1000.0);
      const f_min = f_rev * rpm;
      $("rf_out").textContent = `毎回転切削送り: ${Math.trunc(f_rev*10000)/10000} mm/rev\n毎分切削送り:  ${Math.trunc(f_min*10000)/10000} mm/min\n${note}`;
    }

    function calcMill(){
      const D=parseFloat($("ml_d").value), phi=parseFloat($("ml_phi").value), d=parseFloat($("ml_dlen").value), air=parseFloat($("ml_air").value);
      const h=Math.sqrt((phi/2)*(phi/2)-d*d), start=h+D/2+air, end=-(h+air);
      $("ml_out").textContent=`h  : ${fmt(h)} mm\n始点: ${fmt(start)}\n終点: ${fmt(end)}`;
    }

    function calcCornerR(){
      const OD=parseFloat($("cr_phi").value), len=parseFloat($("cr_len").value), R2=parseFloat($("cr_r2").value), R1=parseFloat($("cr_r1").value), theta=parseFloat($("cr_theta").value), Zval=parseFloat($("cr_zval").value), noseR=parseFloat($("cr_nose").value);
      const tan=(x)=>Math.tan(rad(x)), sin=(x)=>Math.sin(rad(x)), cos=(x)=>Math.cos(rad(x));
      const corr = noseR*(1-tan(theta/2));
      const cmdLen = len + corr;
      const R2cmd = noseR + R2, R1cmd = noseR + R1;
      const K8=Zval, K5=tan(theta/2)*R2cmd + cmdLen + K8, I5=OD;
      const I6=OD - ((R2cmd - (R2cmd*cos(theta)))*2);
      const K6=K5 - (R2cmd*sin(theta));
      const I8=(OD - ((cmdLen*tan(theta))*2)) - (R1cmd*tan((90-theta)/2)*2);
      const I7=(R1cmd*sin(90-theta))*2 + I8;
      const K7=R1cmd - R1cmd*cos(90-theta) + Zval;
      $("cr_out").textContent = [
      `補正量　: ${f4(corr)} mm`,
      `指令面長: ${f4(cmdLen)} mm`,
      "",
      coordRow("D", I5, K5),
      coordRow("C", I6, K6),
      coordRow("B", I7, K7),
      coordRow("A", I8, K8)
    ].join("\n");
    }

    toggleRMode();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>

  <div id="mode"></div>
  <script>
    function isStandalone(){
      return window.matchMedia('(display-mode: standalone)').matches
             || window.navigator.standalone === true;
    }
    function setMode(){
      const el=document.getElementById('mode');
      if(el) el.textContent='mode: '+(isStandalone()?'standalone':'browser');
    }
    document.addEventListener('DOMContentLoaded', setMode);
    window.addEventListener('pageshow', setMode);
  </script>

</body>
</html>
